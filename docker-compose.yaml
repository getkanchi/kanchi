version: "3.9"

services:
  kanchi:
    build:
      context: .
      dockerfile: Dockerfile
    image: kanchi:latest
    ports:
      - "8765:8765"
      - "3000:3000"
    environment:
      # Required: point to your existing Celery broker (RabbitMQ or Redis)
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:?Set CELERY_BROKER_URL to your broker connection string}

      # Optional overrides (defaults shown)
      DATABASE_URL: ${DATABASE_URL:-sqlite:////data/kanchi.db}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEVELOPMENT_MODE: ${DEVELOPMENT_MODE:-false}
      NUXT_PUBLIC_API_URL: ${NUXT_PUBLIC_API_URL:-http://localhost:8765}
      NUXT_PUBLIC_WS_URL: ${NUXT_PUBLIC_WS_URL:-ws://localhost:8765/ws}
      # Authentication & security (optional)
      AUTH_ENABLED: ${AUTH_ENABLED:-false}
      AUTH_BASIC_ENABLED: ${AUTH_BASIC_ENABLED:-false}
      BASIC_AUTH_USERNAME: ${BASIC_AUTH_USERNAME:-}
      BASIC_AUTH_PASSWORD_HASH: ${BASIC_AUTH_PASSWORD_HASH:-}
      AUTH_GOOGLE_ENABLED: ${AUTH_GOOGLE_ENABLED:-false}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      AUTH_GITHUB_ENABLED: ${AUTH_GITHUB_ENABLED:-false}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      ALLOWED_EMAIL_PATTERNS: ${ALLOWED_EMAIL_PATTERNS:-}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      SESSION_SECRET_KEY: ${SESSION_SECRET_KEY:-change-me}
      TOKEN_SECRET_KEY: ${TOKEN_SECRET_KEY:-change-me}
      OAUTH_REDIRECT_BASE_URL: ${OAUTH_REDIRECT_BASE_URL:-http://localhost:8765}
    volumes:
      - kanchi_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  kanchi_data:
